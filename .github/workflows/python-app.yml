name: Deploy FastAPI Backend via Jump Host using rsync

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies (for build/test)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install SSH and rsync
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync openssh-client

      - name: Set up SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/jump-key.pem
          chmod 600 ~/.ssh/jump-key.pem
          ssh-keyscan -H ${{ secrets.JUMP_HOST }} >> ~/.ssh/known_hosts
          ssh-keyscan -H ${{ secrets.PRIVATE_IP }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection via Jump Host
        run: |
          ssh -i ~/.ssh/jump-key.pem -o ProxyJump=${{ secrets.JUMP_USER }}@${{ secrets.JUMP_HOST }} -o StrictHostKeyChecking=no ${{ secrets.PRIVATE_USER }}@${{ secrets.PRIVATE_IP }} "echo 'âœ… Connected to Private EC2 via Jump Host'"

      - name: Rsync code to Private EC2
        run: |
          rsync -avz --delete \
            --exclude='.git/' \
            --exclude='__pycache__/' \
            --exclude='venv/' \
            --exclude='.env' \
            -e "ssh -i ~/.ssh/jump-key.pem -o ProxyJump=${{ secrets.JUMP_USER }}@${{ secrets.JUMP_HOST }} -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.PRIVATE_USER }}@${{ secrets.PRIVATE_IP }}:/home/ubuntu/cricket-auction-backend

      - name: Restart backend using pm2
        run: |
          ssh -i ~/.ssh/jump-key.pem -o ProxyJump=${{ secrets.JUMP_USER }}@${{ secrets.JUMP_HOST }} -o StrictHostKeyChecking=no ${{ secrets.PRIVATE_USER }}@${{ secrets.PRIVATE_IP }} "
            cd /home/ubuntu/cricket-auction-backend &&
            python3 -m venv venv &&
            source venv/bin/activate &&
            pip install -r requirements.txt &&
            pm2 stop cricket-backend || true &&
            pm2 start 'uvicorn app.main:app --host 0.0.0.0 --port 8000' --name cricket-backend
          "
